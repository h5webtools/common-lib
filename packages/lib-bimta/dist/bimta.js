!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.Bimta=e()}(this,function(){"use strict";function t(t,e,n){if(t+="",(e-=t.length)<=0)return t;if(n||0===n||(n=" ")," "===(n+="")&&e<10)return d[e]+t;for(var i="";;){if(1&e&&(i+=n),!(e>>=1))break;n+=n}return i+t}function e(t){var e=arguments[1]||window.location.search.replace("&amp;","&"),n=new RegExp("(^|&)"+t+"=([^&]*)(&|$)"),i=e.substr(e.indexOf("?")+1).match(n);return null!=i?i[2]:""}function n(t){var e=new RegExp("(^| )"+t+"(?:=([^;]*))?(;|$)"),n=document.cookie.match(e);return n?n[2]?unescape(n[2]):"":null}function i(){var e=new Date;return e.getFullYear()+"-"+t(e.getMonth()+1,2,"0")+"-"+t(e.getDate(),2,"0")+" "+t(e.getHours(),2,"0")+":"+t(e.getMinutes(),2,"0")+":"+t(e.getSeconds(),2,"0")}function a(t){return t=t||"bimta",String(Math.random()+Math.random()).replace(h,t)}function o(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],i={};for(var a in e)m.call(e,a)&&!~n.indexOf(a)&&(i[a]=e[a]);for(var o in t)m.call(t,o)&&void 0===i[o]&&(i[o]=t[o]);return i}function r(t,e){if(c(t))t.forEach(function(t,n){e&&e(t,n)});else if(u(t))for(var n in t)m.call(t,n)&&e&&e(t[n],n)}function s(t){return"[object String]"===g.call(t)}function c(t){return Array.isArray(t)}function u(t){return"[object Object]"===g.call(t)}function l(t){console.log("INFO: "+t)}function f(t){console.log("WARN: "+t)}function p(){return{}}var d=[""," ","  ","   ","    ","     ","      ","       ","        ","         "],h=/\d\.\d{4}/,v="__DSTAT_UUID__",g=Object.prototype.toString,m=Object.prototype.hasOwnProperty,_=window.navigator.userAgent,y=_.match(/(Android);?[\s\/]+([\d.]+)?/),b=_.match(/(iPad).*OS\s([\d_]+)/),k=_.match(/(iPod)(.*OS\s([\d_]+))?/),w=!b&&_.match(/(iPhone\sOS)\s([\d_]+)/),S=/jiayoubao/.test(_.toLowerCase()),A={};A.jyb=S,y&&(A.android=!0,A.version=y[2]),w&&!k&&(A.ios=A.iphone=!0,A.version=w[2].replace(/_/g,".")),b&&(A.ios=A.ipad=!0,A.version=b[2].replace(/_/g,".")),k&&(A.ios=A.ipod=!0,A.version=k[3]?k[3].replace(/_/g,"."):null);var j=e("userid")||n("userid")||"",O=function(){try{var t=window.localStorage.getItem(v);return t||(t=a(),window.localStorage.setItem(v,t)),t}catch(t){return a()}}(),I={test:"//172.16.1.16:8890",prod:"//report.jyblife.com"},E={ak:"KVQiUTJf",cmd:"65010000"},C="";A.android?C="android":A.ios&&(C="ios");var D={src:"//pingjs.qq.com/h5/stats.js?v2.0.4",name:"MTAH5",sid:"500478186",cid:"500478188"},R={bi:{env:"test",options:{},init:function(t,e){this.env=t,this.options=o(E,e||{})},pageview:function(t,e){this._track(t,e)},event:function(t,e){this._track(t,e)},_track:function(t,n){if(t){n=n||{};var a=new Image,r=I[this.env],s={ak:this.options.ak,body:JSON.stringify({cmd:this.options.cmd,data:[{sid:"",op_type:n.op_type||"click",op_result:"",op_time:i(),op_object:t,op_page:"",op_params:o({platform:C,in_app:A.jyb?1:0,cust_id:j,uniq_id:j||O,source:e("channel")||e("from")||"",act_id:"",group:""},n,["op_type"])}]})},c=[];for(var u in s)c.push(encodeURIComponent(u)+"="+encodeURIComponent(s[u]));a.src=r+"?"+c.join("&")}}},mta:{env:"test",options:{},_trackCache:[],init:function(t,e){var n=this;this.env=t,this.options=o(D,e||{}),window._mtac={performanceMonitor:1};var i=document.createElement("script"),a=document.getElementsByTagName("script")[0];for(var r in this.options)m.call(this.options,r)&&i.setAttribute(r,this.options[r]);i.onload=function(){for(var t=null;t=n._trackCache.shift();)t()},a?a.parentNode.insertBefore(i,a):document.getElementsByTagName("head")[0].appendChild(i)},pageview:function(t,e){this._track(t,e)},event:function(t,e){this._track(t,e)},_track:function(t){var e=[],n={};t&&((e=t.split(".")).length<3||(n[e[1]]=e[2],window.MtaH5?window.MtaH5.clickStat(e[0],n):this._trackCache.push(function(){window.MtaH5.clickStat(e[0],n)})))}}},M=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},P=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),T=/data\-(\w*)\-(\w*)/,N={ea:"data-stat-ea",eb:"data-stat-eb",ec:"data-stat-ec",visit:"data-stat-visit",para:"data-stat-para"},x={debug:!1},U=function(){function t(e){M(this,t),this.options=o(x,e||{}),this.attrs=N,this.alias={},this.init()}return P(t,[{key:"init",value:function(){var t=this.options.debug;for(var e in N){var n=N[e];T.test(n)?this.alias[e]=N[e].replace(T,function(t,e,n){return e+n.charAt(0).toUpperCase()+n.slice(1)}):t&&f(e+", "+n+" 格式有误")}}},{key:"getDataSetObj",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return e.forEach(function(e){void 0!==n[e]&&(t[e]=n[e])}),t}},{key:"getDataSetArr",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return(arguments.length>1&&void 0!==arguments[1]?arguments[1]:[]).map(function(e){return t[e]})}},{key:"checkDataSetValue",value:function(){for(var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=!0,i=0,a=e.length;i<a;i++)if(void 0===t[e[i]]){n=!1;break}return n}}]),t}(),H=/^\s*\{(.*)\}\s*$/,q=/[\s"']*([^:,"'\{\}]+)[\s"']*:[\s"']*([^:,"'\{\}]+)[\s"']*,?/g,B={configMap:{},platform:["bi","mta"],createCommonParams:p,env:"test",debug:!1};return function(){function t(e){M(this,t),this.options=o(B,e||{}),this.dataAttribute=new U({debug:this.options.debug})}return P(t,[{key:"start",value:function(){return this._init(),this._initPageviewReport(),this._initEventReport(),this}},{key:"parseOption",value:function(t){if(H.test(t)){for(var e={},n="";n=q.exec(t);)e[n[1]]=n[2];return e}return{}}},{key:"pageview",value:function(t,e){u(t)&&(t.ec="pv"),this._call("pageview",t,e)}},{key:"event",value:function(t,e){this._call("event",t,e)}},{key:"getCommonParams",value:function(){return this.options.createCommonParams({})}},{key:"_init",value:function(){var t=this.options.env;r(this.options.platform,function(e,n){var i=null,a={};s(e)?i=R[e]:(i=R[n],a=e),i.init(t,a)})}},{key:"_initPageviewReport",value:function(){var t=this,e=this.dataAttribute,n=document.querySelectorAll("["+e.attrs.visit+"]"),i=e.alias;n.length>0&&window.setTimeout(function(){t._dataAttrReport("pageview",n[0],[i.ea,i.eb,i.visit,i.para])},0)}},{key:"_initEventReport",value:function(){var t=this;document.body.addEventListener("click",function(e){window.setTimeout(function(){var n=e.target,i=t.dataAttribute.alias;t._dataAttrReport("event",n,[i.ea,i.eb,i.ec,i.para])},0)},!0)}},{key:"_dataAttrReport",value:function(t,e,n){for(var i={},a=[],o={},r="",s=this.dataAttribute,c=s.alias;e!==document.documentElement&&(s.getDataSetObj(i,n,e.dataset),!i[c.ea]);)e=e.parentNode;s.checkDataSetValue(i,n.slice(0,3))&&(a=s.getDataSetArr(i,n),o=this.parseOption(a.pop()),r=this._getIdsStr.apply(this,a),this._call(t,r,o))}},{key:"_getIds",value:function(){for(var t=this.options.configMap,e=[],n=0,i=arguments.length;n<i;n++)void 0!==(t=t[arguments[n]])&&t.id&&e.push(t.id);return e}},{key:"_getIdsStr",value:function(){return this._getIds.apply(this,arguments).join(".")}},{key:"_log",value:function(t){this.options.debug&&l(t)}},{key:"_checkEventID",value:function(t){if(s(t)){if(3===t.split(".").length)return!0}else if(u(t)&&m.call(t,"ea")&&m.call(t,"eb")&&m.call(t,"ec"))return!0;return!1}},{key:"_call",value:function(t,e,n){if(n=n||{},!this._checkEventID(e))return this._log('事件ID格式错误，应该为30000.1.1或者{ea: "home", eb: "search", ec: "btn"}');var i=this.getCommonParams(),a={},c="";return s(e)?c=e:u(e)&&(c=this._getIdsStr(e.ea,e.eb,e.ec)),!!c&&(a=o(i,n),r(this.options.platform,function(e,n){(s(e)?R[e]:R[n])[t](c,a)}),this._log("["+t+"] ids: "+c+", params: "+JSON.stringify(a)),!0)}}]),t}()});
