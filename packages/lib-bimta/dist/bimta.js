!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.Bimta=e()}(this,function(){"use strict";function t(t){var e=arguments[1]||window.location.search.replace("&amp;","&"),n=new RegExp("(^|&)"+t+"=([^&]*)(&|$)"),i=e.substr(e.indexOf("?")+1).match(n);return null!=i?i[2]:""}function e(t){var e=new RegExp("(^| )"+t+"(?:=([^;]*))?(;|$)"),n=document.cookie.match(e);return n?n[2]?unescape(n[2]):"":null}function n(t){return t=t||"dstat",String(Math.random()+Math.random()).replace(p,t)}function i(t,e){for(var n in t)g.call(t,n)&&void 0===e[n]&&(e[n]=t[n]);return e}function a(t,e){if(r(t))t.forEach(function(t,n){e&&e(t,n)});else if(c(t))for(var n in t)g.call(t,n)&&e&&e(t[n],n)}function o(t){return"[object String]"===d.call(t)}function r(t){return Array.isArray(t)}function c(t){return"[object Object]"===d.call(t)}function s(t){console.log("INFO: "+t)}function u(t){console.log("WARN: "+t)}function l(t,e,n){if(e){var a=new Image,o=_[t],r={ak:"KVQiUTJf",body:JSON.stringify({cmd:"65010000",data:[{sid:"",op_type:"click",op_result:"",op_time:Date.now(),op_object:e,op_page:"",op_params:i(n||{},{cust_id:m,uniq_id:m||y,source:"",group:""})}]})},c=[];for(var s in r)c.push(encodeURIComponent(s)+"="+encodeURIComponent(r[s]));a.src=o+"?"+c.join("&")}}function f(){return{}}var p=/\d\.\d{4}/,v="__DSTAT_UUID__",h=Array.prototype.slice,d=Object.prototype.toString,g=Object.prototype.hasOwnProperty,m=t("userid")||e("userid")||"",y=function(){try{var t=window.localStorage.getItem(v);return t||(t=n(),window.localStorage.setItem(v,t)),t}catch(t){return n()}}(),_={test:"//172.16.1.16:8890",prod:"//report.jyblife.com"},b={bi:{env:"test",init:function(t){this.env=t},pageview:function(t,e){l(this.env,t,e)},event:function(t,e){l(this.env,t,e)}},mta:{env:"test",_trackCache:[],init:function(t,e){var n=this;this.env=t,i({name:"MTAH5",sid:"500478186",cid:"500478188"},e||{}),window._mtac={performanceMonitor:1};var a=document.createElement("script"),o=document.getElementsByTagName("script")[0];a.src="//pingjs.qq.com/h5/stats.js?v2.0.4";for(var r in e)g.call(e,r)&&a.setAttribute(r,e[r]);a.onload=function(){for(var t=null;t=n._trackCache.shift();)t()},o.parentNode.insertBefore(a,o)},pageview:function(t,e){this._track(t,e)},event:function(t,e){this._track(t,e)},_track:function(t){var e=[],n={};t&&((e=t.split(".")).length<3||(n[e[1]]=e[2],window.MtaH5?window.MtaH5.clickStat(e[0],n):this._trackCache.push(function(){window.MtaH5.clickStat(e[0],n)})))}}},k=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},w=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),S=/data\-(\w*)\-(\w*)/,j={ea:"data-stat-ea",eb:"data-stat-eb",ec:"data-stat-ec",visit:"data-stat-visit",para:"data-stat-para"},I={debug:!1},E=function(){function t(e){k(this,t),this.options=i(I,e||{}),this.attrs=j,this.alias={},this.init()}return w(t,[{key:"init",value:function(){var t=this.options.debug;for(var e in j){var n=j[e];S.test(n)?this.alias[e]=j[e].replace(S,function(t,e,n){return e+n.charAt(0).toUpperCase()+n.slice(1)}):t&&u(e+", "+n+" 格式有误")}}},{key:"getDataSetObj",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return e.forEach(function(e){void 0!==n[e]&&(t[e]=n[e])}),t}},{key:"getDataSetArr",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return(arguments.length>1&&void 0!==arguments[1]?arguments[1]:[]).map(function(e){return t[e]})}},{key:"checkDataSetValue",value:function(){for(var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=!0,i=0,a=e.length;i<a;i++)if(void 0===t[e[i]]){n=!1;break}return n}}]),t}(),O=/^\s*\{(.*)\}\s*$/,A=/[\s"']*([^:,"']+)[\s"']*:[\s"']*([^:,"']+)[\s"']*,?/g,C={configMap:{},platform:["bi","mta"],createCommonParams:f,env:"test",debug:!1};return function(){function t(e){k(this,t),this.options=i(C,e||{}),this.dataAttribute=new E({debug:this.options.debug})}return w(t,[{key:"start",value:function(){return this._init(),this._initPageviewReport(),this._initEventReport(),this}},{key:"parseOption",value:function(t){if(O.test(t)){for(var e={},n="";n=A.exec(t);)e[n[1]]=n[2];return e}return{}}},{key:"pageview",value:function(t,e){c(t)&&(t.ec="visit"),this._call("pageview",t,e)}},{key:"event",value:function(t,e){this._call("event",t,e)}},{key:"getCommonParams",value:function(){return this.options.createCommonParams({})}},{key:"_init",value:function(){var t=this.options.env;a(this.options.platform,function(e,n){var i=null,a={};o(e)?i=b[e]:(i=b[n],a=e),i.init(t,a)})}},{key:"_initPageviewReport",value:function(){}},{key:"_initEventReport",value:function(){var t=this;document.body.addEventListener("click",function(e){window.setTimeout(function(){for(var n=e.target,i={},a=[],o=t.dataAttribute,r=o.alias,c=[r.ea,r.eb,r.ec,r.para];n!==document.documentElement&&(o.getDataSetObj(i,c,n.dataset),!i[r.ea]);)n=n.parentNode;o.checkDataSetValue(i,c.slice(0,3))&&(a=o.getDataSetArr(i,c),t._event.apply(t,a))},0)})}},{key:"_getIds",value:function(){for(var t=this.options.configMap,e=[],n=0,i=arguments.length;n<i;n++)void 0!==(t=t[arguments[n]])&&t.id&&e.push(t.id);return e}},{key:"_getIdsStr",value:function(){return this._getIds.apply(this,arguments).join(".")}},{key:"_event",value:function(){var t=this,e=h.call(arguments,0),n=i(this.getCommonParams(),this.parseOption(e.pop())),a=this._getIdsStr.apply(this,e);this.options.platform.forEach(function(e){var i=b[e];i&&(i.event(a,n),t._log("[event] ids: "+a+", params: "+JSON.stringify(n)))})}},{key:"_log",value:function(t){this.options.debug&&s(t)}},{key:"_checkEventID",value:function(t){if(o(t)){if(3===t.split(".").length)return!0}else if(c(t)&&g.call(t,"ea")&&g.call(t,"eb")&&g.call(t,"ec"))return!0;return!1}},{key:"_call",value:function(t,e,n){if(n=n||{},!this._checkEventID(e))return this._log('事件ID格式错误，应该为30000.1.1或者{ea: "home", eb: "search", ec: "btn"}');var r=this.getCommonParams(),s="";return o(e)?s=e:c(e)&&(s=this._getIdsStr(e.ea,e.eb,e.ec)),!!s&&(i(r,n),a(this.options.platform,function(e,i){(o(e)?b[e]:b[i])[t](s,n)}),this._log("["+t+"] ids: "+s+", params: "+JSON.stringify(n)),!0)}}]),t}()});
