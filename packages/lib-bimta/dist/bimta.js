!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.Bimta=e()}(this,function(){"use strict";function t(t){var e=arguments[1]||window.location.search.replace("&amp;","&"),n=new RegExp("(^|&)"+t+"=([^&]*)(&|$)"),i=e.substr(e.indexOf("?")+1).match(n);return null!=i?i[2]:""}function e(t){var e=new RegExp("(^| )"+t+"(?:=([^;]*))?(;|$)"),n=document.cookie.match(e);return n?n[2]?unescape(n[2]):"":null}function n(t){return t=t||"bimta",String(Math.random()+Math.random()).replace(f,t)}function i(t,e){for(var n in t)d.call(t,n)&&void 0===e[n]&&(e[n]=t[n]);return e}function a(t,e){if(r(t))t.forEach(function(t,n){e&&e(t,n)});else if(s(t))for(var n in t)d.call(t,n)&&e&&e(t[n],n)}function o(t){return"[object String]"===h.call(t)}function r(t){return Array.isArray(t)}function s(t){return"[object Object]"===h.call(t)}function c(t){console.log("INFO: "+t)}function u(t){console.log("WARN: "+t)}function l(){return{}}var f=/\d\.\d{4}/,p="__DSTAT_UUID__",h=Object.prototype.toString,d=Object.prototype.hasOwnProperty,v=t("userid")||e("userid")||"",g=function(){try{var t=window.localStorage.getItem(p);return t||(t=n(),window.localStorage.setItem(p,t)),t}catch(t){return n()}}(),m={test:"//172.16.1.16:8890",prod:"//report.jyblife.com"},_={ak:"KVQiUTJf",cmd:"65010000"},y={src:"//pingjs.qq.com/h5/stats.js?v2.0.4",name:"MTAH5",sid:"500478186",cid:"500478188"},b={bi:{env:"test",options:{},init:function(t,e){this.env=t,this.options=e||{},i(_,this.options)},pageview:function(t,e){this._track(t,e)},event:function(t,e){this._track(t,e)},_track:function(t,e){if(t){var n=new Image,a=m[this.env],o={ak:this.options.ak,body:JSON.stringify({cmd:this.options.cmd,data:[{sid:"",op_type:"click",op_result:"",op_time:Date.now(),op_object:t,op_page:"",op_params:i({cust_id:v,uniq_id:v||g,source:"",act_id:"",group:""},e||{})}]})},r=[];for(var s in o)r.push(encodeURIComponent(s)+"="+encodeURIComponent(o[s]));n.src=a+"?"+r.join("&")}}},mta:{env:"test",options:{},_trackCache:[],init:function(t,e){var n=this;this.env=t,this.options=e||{},i(y,this.options),window._mtac={performanceMonitor:1};var a=document.createElement("script"),o=document.getElementsByTagName("script")[0];for(var r in this.options)d.call(this.options,r)&&a.setAttribute(r,this.options[r]);a.onload=function(){for(var t=null;t=n._trackCache.shift();)t()},o?o.parentNode.insertBefore(a,o):document.getElementsByTagName("head")[0].appendChild(a)},pageview:function(t,e){this._track(t,e)},event:function(t,e){this._track(t,e)},_track:function(t){var e=[],n={};t&&((e=t.split(".")).length<3||(n[e[1]]=e[2],window.MtaH5?window.MtaH5.clickStat(e[0],n):this._trackCache.push(function(){window.MtaH5.clickStat(e[0],n)})))}}},k=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},w=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),S=/data\-(\w*)\-(\w*)/,A={ea:"data-stat-ea",eb:"data-stat-eb",ec:"data-stat-ec",visit:"data-stat-visit",para:"data-stat-para"},j={debug:!1},I=function(){function t(e){k(this,t),this.options=i(j,e||{}),this.attrs=A,this.alias={},this.init()}return w(t,[{key:"init",value:function(){var t=this.options.debug;for(var e in A){var n=A[e];S.test(n)?this.alias[e]=A[e].replace(S,function(t,e,n){return e+n.charAt(0).toUpperCase()+n.slice(1)}):t&&u(e+", "+n+" 格式有误")}}},{key:"getDataSetObj",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return e.forEach(function(e){void 0!==n[e]&&(t[e]=n[e])}),t}},{key:"getDataSetArr",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return(arguments.length>1&&void 0!==arguments[1]?arguments[1]:[]).map(function(e){return t[e]})}},{key:"checkDataSetValue",value:function(){for(var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=!0,i=0,a=e.length;i<a;i++)if(void 0===t[e[i]]){n=!1;break}return n}}]),t}(),E=/^\s*\{(.*)\}\s*$/,O=/[\s"']*([^:,"'\{\}]+)[\s"']*:[\s"']*([^:,"'\{\}]+)[\s"']*,?/g,C={configMap:{},platform:["bi","mta"],createCommonParams:l,env:"test",debug:!1};return function(){function t(e){k(this,t),this.options=i(C,e||{}),this.dataAttribute=new I({debug:this.options.debug})}return w(t,[{key:"start",value:function(){return this._init(),this._initPageviewReport(),this._initEventReport(),this}},{key:"parseOption",value:function(t){if(E.test(t)){for(var e={},n="";n=O.exec(t);)e[n[1]]=n[2];return e}return{}}},{key:"pageview",value:function(t,e){s(t)&&(t.ec="pv"),this._call("pageview",t,e)}},{key:"event",value:function(t,e){this._call("event",t,e)}},{key:"getCommonParams",value:function(){return this.options.createCommonParams({})}},{key:"_init",value:function(){var t=this.options.env;a(this.options.platform,function(e,n){var i=null,a={};o(e)?i=b[e]:(i=b[n],a=e),i.init(t,a)})}},{key:"_initPageviewReport",value:function(){var t=this,e=this.dataAttribute,n=document.querySelectorAll("["+e.attrs.visit+"]"),i=e.alias;n.length>0&&window.setTimeout(function(){t._dataAttrReport("pageview",n[0],[i.ea,i.eb,i.visit,i.para])},0)}},{key:"_initEventReport",value:function(){var t=this;document.body.addEventListener("click",function(e){window.setTimeout(function(){var n=e.target,i=t.dataAttribute.alias;t._dataAttrReport("event",n,[i.ea,i.eb,i.ec,i.para])},0)},!0)}},{key:"_dataAttrReport",value:function(t,e,n){for(var i={},a=[],o={},r="",s=this.dataAttribute,c=s.alias;e!==document.documentElement&&(s.getDataSetObj(i,n,e.dataset),!i[c.ea]);)e=e.parentNode;s.checkDataSetValue(i,n.slice(0,3))&&(a=s.getDataSetArr(i,n),o=this.parseOption(a.pop()),r=this._getIdsStr.apply(this,a),this._call(t,r,o))}},{key:"_getIds",value:function(){for(var t=this.options.configMap,e=[],n=0,i=arguments.length;n<i;n++)void 0!==(t=t[arguments[n]])&&t.id&&e.push(t.id);return e}},{key:"_getIdsStr",value:function(){return this._getIds.apply(this,arguments).join(".")}},{key:"_log",value:function(t){this.options.debug&&c(t)}},{key:"_checkEventID",value:function(t){if(o(t)){if(3===t.split(".").length)return!0}else if(s(t)&&d.call(t,"ea")&&d.call(t,"eb")&&d.call(t,"ec"))return!0;return!1}},{key:"_call",value:function(t,e,n){if(n=n||{},!this._checkEventID(e))return this._log('事件ID格式错误，应该为30000.1.1或者{ea: "home", eb: "search", ec: "btn"}');var r=this.getCommonParams(),c="";return o(e)?c=e:s(e)&&(c=this._getIdsStr(e.ea,e.eb,e.ec)),!!c&&(i(r,n),a(this.options.platform,function(e,i){(o(e)?b[e]:b[i])[t](c,n)}),this._log("["+t+"] ids: "+c+", params: "+JSON.stringify(n)),!0)}}]),t}()});
