!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.Bimta=e()}(this,function(){"use strict";function t(t,e,n){if(t+="",(e-=t.length)<=0)return t;if(n||0===n||(n=" ")," "===(n+="")&&e<10)return d[e]+t;for(var i="";;){if(1&e&&(i+=n),!(e>>=1))break;n+=n}return i+t}function e(t){var e=arguments[1]||window.location.search.replace("&amp;","&"),n=new RegExp("(^|&)"+t+"=([^&]*)(&|$)"),i=e.substr(e.indexOf("?")+1).match(n);return null!=i?i[2]:""}function n(t){var e=new RegExp("(^| )"+t+"(?:=([^;]*))?(;|$)"),n=document.cookie.match(e);return n?n[2]?unescape(n[2]):"":null}function i(){var e=new Date;return e.getFullYear()+"-"+t(e.getMonth()+1,2,"0")+"-"+t(e.getDate(),2,"0")+" "+t(e.getHours(),2,"0")+":"+t(e.getMinutes(),2,"0")+":"+t(e.getSeconds(),2,"0")}function a(t){return t=t||"bimta",String(Math.random()+Math.random()).replace(p,t)}function r(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],i={};for(var a in e)m.call(e,a)&&!~n.indexOf(a)&&(i[a]=e[a]);for(var r in t)m.call(t,r)&&void 0===i[r]&&(i[r]=t[r]);return i}function o(t,e){if(c(t))t.forEach(function(t,n){e&&e(t,n)});else if(u(t))for(var n in t)m.call(t,n)&&e&&e(t[n],n)}function s(t){return"[object String]"===g.call(t)}function c(t){return Array.isArray(t)}function u(t){return"[object Object]"===g.call(t)}function l(t){console.log("INFO: "+t)}function f(t){console.log("WARN: "+t)}function h(){return{}}var d=[""," ","  ","   ","    ","     ","      ","       ","        ","         "],p=/\d\.\d{4}/,v="__DSTAT_UUID__",g=Object.prototype.toString,m=Object.prototype.hasOwnProperty,y=window.navigator.userAgent,_=y.match(/(Android);?[\s\/]+([\d.]+)?/),b=y.match(/(iPad).*OS\s([\d_]+)/),k=y.match(/(iPod)(.*OS\s([\d_]+))?/),w=!b&&y.match(/(iPhone\sOS)\s([\d_]+)/),A=/jiayoubao/.test(y.toLowerCase()),S={};S.jyb=A,_&&(S.android=!0,S.version=_[2]),w&&!k&&(S.ios=S.iphone=!0,S.version=w[2].replace(/_/g,".")),b&&(S.ios=S.ipad=!0,S.version=b[2].replace(/_/g,".")),k&&(S.ios=S.ipod=!0,S.version=k[3]?k[3].replace(/_/g,"."):null);var j=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},O=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),I=function(t){if(Array.isArray(t)){for(var e=0,n=Array(t.length);e<t.length;e++)n[e]=t[e];return n}return Array.from(t)},E=e("userid")||n("userid")||"",C=function(){try{var t=window.localStorage.getItem(v);return t||(t=a(),window.localStorage.setItem(v,t)),t}catch(t){return a()}}(),D={test:"//172.16.1.16:8890",prod:"//report.jyblife.com"},M={ak:"KVQiUTJf",cmd:"65010000"},R="";S.android?R="android":S.ios&&(R="ios");var P={test:{src:"//pingjs.qq.com/h5/stats.js?v2.0.4",name:"MTAH5",sid:"500499846",cid:"500499847"},prod:{src:"//pingjs.qq.com/h5/stats.js?v2.0.4",name:"MTAH5",sid:"500478186",cid:"500478188"}},T={bi:function(){function t(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"test",i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};j(this,t),this.platform="bi",this.debug=e,this.env=n,this.options=r(M,i)}return O(t,[{key:"init",value:function(){return this}},{key:"pageview",value:function(t,e){this._track("pageview",t,e)}},{key:"event",value:function(t,e){this._track("event",t,e)}},{key:"_track",value:function(t,n,a){if(n){a=a||{};var o=new Image,s=D[this.env]||"",c={ak:this.options.ak,body:JSON.stringify({cmd:this.options.cmd,data:[{sid:"",op_type:a.op_type||"click",op_result:"",op_time:i(),op_object:n,op_page:"",op_params:r({platform:R,in_app:S.jyb?1:0,cust_id:E,uniq_id:E||C,source:e("channel")||e("from")||"",act_id:"",group:""},a,["op_type"])}]})},u=[];for(var f in c)u.push(encodeURIComponent(f)+"="+encodeURIComponent(c[f]));o.src=s+"?"+u.join("&"),this.debug&&l("["+t+"] platform: "+this.platform+", ids: "+n+", query: "+JSON.stringify(c))}}}]),t}(),mta:function(){function t(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"test",i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};j(this,t),this.platform="mta",this.debug=e,this.env=n,this.options=r(P[n]||{},i),this._trackCache=[]}return O(t,[{key:"init",value:function(){var t=this;window._mtac={performanceMonitor:1};var e=document.createElement("script"),n=document.getElementsByTagName("script")[0];for(var i in this.options)m.call(this.options,i)&&e.setAttribute(i,this.options[i]);return e.onload=function(){for(var e=null;e=t._trackCache.shift();)e()},n?n.parentNode.insertBefore(e,n):document.getElementsByTagName("head")[0].appendChild(e),this}},{key:"pageview",value:function(t,e){this._track("pageview",t,e)}},{key:"event",value:function(t,e){this._track("event",t,e)}},{key:"_track",value:function(t,e){var n=[],i={};e&&((n=e.split(".")).length<3||(i[n[1]]=n[2],window.MtaH5?window.MtaH5.clickStat(n[0],i):this._trackCache.push(function(){window.MtaH5.clickStat(n[0],i)}),this.debug&&l("["+t+"] platform: "+this.platform+", ids: "+e)))}}]),t}()},N=/data\-(\w*)\-(\w*)/,q={ea:"data-stat-ea",eb:"data-stat-eb",ec:"data-stat-ec",visit:"data-stat-visit",para:"data-stat-para"},x={debug:!1},H=function(){function t(e){j(this,t),this.options=r(x,e||{}),this.attrs=q,this.alias={},this.init()}return O(t,[{key:"init",value:function(){var t=this.options.debug;for(var e in q){var n=q[e];N.test(n)?this.alias[e]=q[e].replace(N,function(t,e,n){return e+n.charAt(0).toUpperCase()+n.slice(1)}):t&&f(e+", "+n+" 格式有误")}}},{key:"getDataSetObj",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return e.forEach(function(e){void 0!==n[e]&&(t[e]=n[e])}),t}},{key:"getDataSetArr",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return(arguments.length>1&&void 0!==arguments[1]?arguments[1]:[]).map(function(e){return t[e]})}},{key:"checkDataSetValue",value:function(){for(var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=!0,i=0,a=e.length;i<a;i++)if(void 0===t[e[i]]){n=!1;break}return n}}]),t}(),U=/^\s*\{(.*)\}\s*$/,B=/[\s"']*([^:,"'{}]+)[\s"']*:[\s"']*([^:,"'{}]+)[\s"']*,?/g,J={configMap:{},platform:["bi","mta"],createCommonParams:h,env:"test",debug:!1};return function(){function t(e){j(this,t),this.platform={},this.options=r(J,e||{}),this.dataAttribute=new H({debug:this.options.debug})}return O(t,[{key:"start",value:function(){try{this._init(),this._initPageviewReport(),this._initEventReport()}catch(t){this._log(t)}return this}},{key:"parseOption",value:function(t){if(U.test(t)){for(var e={},n="";n=B.exec(t);)e[n[1]]=n[2];return e}return{}}},{key:"pageview",value:function(t,e){u(t)&&(t.ec="pv"),this._call("pageview",t,e)}},{key:"event",value:function(t,e){this._call("event",t,e)}},{key:"getCommonParams",value:function(){return this.options.createCommonParams({})}},{key:"_init",value:function(){var t=this,e=this.options,n=e.env,i=e.debug;this._log("当前埋点环境为："+n),o(this.options.platform,function(e,a){var r=null,o={},c="";s(e)?(c=e,r=T[e]):(c=a,o=e,r=T[a]),t.platform[c]=new r(i,n,o),t.platform[c].init()})}},{key:"_initPageviewReport",value:function(){var t=this,e=this.dataAttribute,n=document.querySelectorAll("["+e.attrs.visit+"]"),i=e.alias;n.length>0&&window.setTimeout(function(){t._dataAttrReport("pageview",n[0],[i.ea,i.eb,i.visit,i.para])},0)}},{key:"_initEventReport",value:function(){var t=this;document.body.addEventListener("click",function(e){window.setTimeout(function(){var n=e.target,i=t.dataAttribute.alias;t._dataAttrReport("event",n,[i.ea,i.eb,i.ec,i.para])},0)},!0)}},{key:"_dataAttrReport",value:function(t,e,n){for(var i={},a=[],r={},o="",s=this.dataAttribute,c=s.alias;e&&e!==document.documentElement&&(s.getDataSetObj(i,n,e.dataset),!i[c.ea]);)e=e.parentNode;s.checkDataSetValue(i,n.slice(0,3))&&(a=s.getDataSetArr(i,n),r=this.parseOption(a.pop()),o=this._getIdsStr.apply(this,I(a)),this._call(t,o,r))}},{key:"_getIds",value:function(){for(var t=this.options.configMap,e=[],n=arguments.length,i=Array(n),a=0;a<n;a++)i[a]=arguments[a];for(var r=0,o=i.length;r<o;r++)void 0!==(t=t[i[r]])&&t.id&&e.push(t.id);return e}},{key:"_getIdsStr",value:function(){return this._getIds.apply(this,arguments).join(".")}},{key:"_log",value:function(t){this.options.debug&&l(t)}},{key:"_checkEventID",value:function(t){if(s(t)){if(3===t.split(".").length)return!0}else if(u(t)&&m.call(t,"ea")&&m.call(t,"eb")&&m.call(t,"ec"))return!0;return!1}},{key:"_call",value:function(t,e,n){if(n=n||{},!this._checkEventID(e))return this._log('事件ID格式错误，应该为30000.1.1或者{ea: "home", eb: "search", ec: "btn"}');var i=this.getCommonParams(),a={},c="";return s(e)?c=e:u(e)&&(c=this._getIdsStr(e.ea,e.eb,e.ec)),!!c&&(a=r(i,n),o(this.platform,function(e){e[t](c,a)}),!0)}}]),t}()});
