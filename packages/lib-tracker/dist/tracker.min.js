!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.Tracker=e()}(this,function(){"use strict";function t(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments[1],i=window.onerror;window.onerror=function(){var o=Array.prototype.slice.call(arguments);i&&i.apply(window,o);var r=e.apply(window,o);return r.msg.indexOf("Script error")>-1&&!r.url?(t.debug&&console.log(r.msg),!1):(n&&n(r),!1)}}function e(t,e,n,i,o){var r="";return e=e||o&&o.fileName||"",n=n||o&&o.lineNumber||"",i=i||o&&o.columnNumber||"",r=o&&o.stack||"",{msg:t,url:e,line:n,col:i,stack:r}}function n(t,e,n){if(t+="",(e-=t.length)<=0)return t;if(n||0===n||(n=" ")," "===(n+="")&&e<10)return g[e]+t;for(var i="";;){if(1&e&&(i+=n),!(e>>=1))break;n+=n}return i+t}function i(t){return"[object Object]"===y.call(t)}function o(t){var e=arguments[1]||window.location.search.replace("&amp;","&"),n=new RegExp("(^|&)"+t+"=([^&]*)(&|$)"),i=e.substr(e.indexOf("?")+1).match(n);return null!=i?i[2]:""}function r(t){var e=new RegExp("(^| )"+t+"(?:=([^;]*))?(;|$)"),n=document.cookie.match(e);return n?n[2]?unescape(n[2]):"":null}function a(){var t="";return w.android?t="android":w.ios&&(t="ios"),t}function s(t){return t=t||"g_tracker",String(Math.random()+Math.random()).replace(_,t)}function c(){return k||(w.jyb&&"undefined"!=typeof wv?wv.ready(function(){wv.getNetworkType({complete:function(t){k=t.networkType}})}):navigator.connection&&(k=navigator.connection.type||""),k||"")}function u(t){switch(Object.prototype.toString.call(t)){case"[object Error]":case"[object Exception]":case"[object DOMException]":return!0;default:return t instanceof Error}}function d(){var t=new Date;return t.getFullYear()+"-"+n(t.getMonth()+1,2,"0")+"-"+n(t.getDate(),2,"0")+" "+n(t.getHours(),2,"0")+":"+n(t.getMinutes(),2,"0")+":"+n(t.getSeconds(),2,"0")}function p(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n={link:location.href,ua:navigator.userAgent,title:document.title,size:document.documentElement.clientWidth+"*"+document.documentElement.clientHeight,referer:document.referer||"",timestamp:(new Date).getTime(),network:c(),badjs:T.BAD_JS,pid:t.pid},i=j(n,e),r=O[t.env]||"",s={ak:R,body:JSON.stringify({cmd:$,data:[{sid:"",op_type:"error",op_result:"",op_time:d(),op_object:"",op_page:"",op_params:j({platform:a(),in_app:w.jyb?1:0,cust_id:A,uniq_id:A||x,source:o("channel")||o("from")||"",act_id:"",group:""},i)}]})},u=[];for(var p in s)u.push(p+"="+encodeURIComponent(s[p]));t.debug?console.log(JSON.stringify(i,null,2)):l(r+"?"+u.join("&"))}function l(t){var e=s(),n=new Image;window[e]||(window[e]=n,n.onload=n.onerror=function(){window[e]=null,delete window[e]}),n.src=t}function f(t,e){if(!t)return"";var n=t.toString(),i=n.split("\n");return i.length>e?i.slice(0,e).join("\n"):n}function m(t){var e=["method","url","body","time","statusCode","statusText","result"];return e.forEach(function(e){void 0===t[e]&&(t[e]="")}),t.c1=["method","url","body"].map(function(e){return e+":"+t[e]}).join(";"),t.c2=["time","statusCode","statusText"].map(function(e){return e+":"+t[e]}).join(";"),t.c3=t.result,e.forEach(function(e){return delete t[e]}),t}function h(){var t=window.performance||window.webkitPerformance||window.msPerformance||window.mozPerformance;if(void 0===t)return{};var e=t.timing,n={};if(e){if(void 0===n.firstPaint){var i=0;window.chrome&&window.chrome.loadTimes?(i=1e3*window.chrome.loadTimes().firstPaintTime,n.firstPaintTime=i-window.performance.timing.navigationStart):"number"==typeof window.performance.timing.msFirstPaint&&(i=window.performance.timing.msFirstPaint,n.firstPaintTime=i-window.performance.timing.navigationStart)}n.loadTime=e.loadEventEnd-e.fetchStart,n.domReadyTime=e.domComplete-e.domInteractive,n.readyStart=e.fetchStart-e.navigationStart,n.redirectTime=e.redirectEnd-e.redirectStart,n.appcacheTime=e.domainLookupStart-e.fetchStart,n.unloadEventTime=e.unloadEventEnd-e.unloadEventStart,n.lookupDomainTime=e.domainLookupEnd-e.domainLookupStart,n.connectTime=e.connectEnd-e.connectStart,n.requestTime=e.responseEnd-e.requestStart,n.initDomTreeTime=e.domInteractive-e.responseEnd,n.loadEventTime=e.loadEventEnd-e.loadEventStart}return n}function v(t){return i(t)?Object.keys(t).map(function(e){return e+":"+t[e]}).join(";"):""}var w=function(t){var e=t.match(/(Android);?[\s\/]+([\d.]+)?/),n=t.match(/(iPad).*OS\s([\d_]+)/),i=t.match(/(iPod)(.*OS\s([\d_]+))?/),o=!n&&t.match(/(iPhone\sOS)\s([\d_]+)/),r=/jiayoubao/.test(t.toLowerCase()),a={};return a.jyb=r,a.ie="ActiveXObject"in window,e&&(a.android=!0,a.version=e[2]),o&&!i&&(a.ios=a.iphone=!0,a.version=o[2].replace(/_/g,".")),n&&(a.ios=a.ipad=!0,a.version=n[2].replace(/_/g,".")),i&&(a.ios=a.ipod=!0,a.version=i[3]?i[3].replace(/_/g,"."):null),a}(window.navigator.userAgent),g=[""," ","  ","   ","    ","     ","      ","       ","        ","         "],y=Object.prototype.toString,_=/\d\.\d{4}/,E="__TRACKER_UUID__",k="";c();var b={JS_ERROR:"1",API_ERROR:"2",PERFORMANCE:"3"},T={BAD_JS:"1"},S=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},P=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),j=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(t[i]=n[i])}return t},O={test:"//172.16.1.16:8890",prod:"//report.jyblife.com"},R="KVQiUTJf",$="65010000",A=o("userid")||r("userid")||"",x=function(){try{var t=window.localStorage.getItem(E);return t||(t=s(),window.localStorage.setItem(E,t)),t}catch(t){return s()}}(),D=function(){function n(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};S(this,n),this.$options=t,this.params=j({t_type:b.JS_ERROR},e),this._init()}return P(n,[{key:"_init",value:function(){var e=this;this.$options.collectWindowErrors&&t(this.$options,function(t){e._send(t)})}},{key:"_send",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};p(this.$options,this._paramsAdaptor(j({},this.params,t)))}},{key:"_paramsAdaptor",value:function(t){var e=["msg","line","col","url","stack"],n=this.$options;return e.forEach(function(e){t[e]||(t[e]="")}),t.c1=[t.msg,t.line,t.col].join(","),t.c2=t.url,t.c3=f(t.stack,n.stackDepth),e.forEach(function(e){return delete t[e]}),t}},{key:"captureError",value:function(t,n){u(t)&&this._send(j(e((t.name||"")+": "+(t.message||""),"","","",t),n))}}]),n}(),C=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};S(this,t),this.$options=e,this.params=j({t_type:b.API_ERROR},n),this._init()}return P(t,[{key:"captureApi",value:function(t){this._send(t,!1)}},{key:"_init",value:function(){this.$options.ajax&&this._ajaxHook(window.XMLHttpRequest)}},{key:"_send",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=j({},this.params,t);e&&(n=m(n)),p(this.$options,n)}},{key:"_ajaxHook",value:function(t){var e=t.prototype.open,n=t.prototype.send,i=this;t.prototype.open=function(t,n){return this._apiTrackData={method:t.toLowerCase(),url:n},e.apply(this,arguments)},t.prototype.send=function(t){return this._apiTrackData.start=Date.now(),this._apiTrackData.body=t?JSON.stringify(t):"",i._addEvent(this),n.apply(this,arguments)}}},{key:"_addEvent",value:function(t){var e=this;t.addEventListener("readystatechange",function(){if(4===t.readyState){var n=t._apiTrackData,i=e.$options.apiCodeList;if(!n)return;var o=Date.now()-n.start,r={method:n.method,url:n.url,body:n.body,time:o,statusCode:t.status,statusText:t.statusText},a=null;if(t.status>=400)return void e._send(j({result:""},r));if(200===t.status)try{if(a=JSON.parse(t.responseText),0===i.length&&0!==a.code&&"0"!==a.code||i.indexOf(a.code)>-1)return void e._send(j({result:(a.code||"")+", "+(a.msg||"")},r))}catch(t){}o>e.$options.apiThreshold&&e._send(j({result:""},r))}},!0)}}]),t}(),L=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};S(this,t),this.$options=e,this.params=j({t_type:b.PERFORMANCE},n),this._init()}return P(t,[{key:"capturePerf",value:function(t){this._send({c2:v(t)})}},{key:"_init",value:function(){this.$options.perf&&this._addEvent()}},{key:"_addEvent",value:function(){var t=this;"complete"===document.readyState?setTimeout(function(){t._send({c1:v(h())})},0):window.addEventListener("load",function(){setTimeout(function(){t._send({c1:v(h())})},0)})}},{key:"_send",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};p(this.$options,j({},this.params,t))}}]),t}(),N={pid:function(){var t=window.location.href,e=t.slice(t.indexOf("://")+3).split(/\/+/);return e.length>2?e[1]:""}(),debug:!1,ajax:!1,perf:!1,apiThreshold:3e3,apiCodeList:[],collectWindowErrors:!0,stackDepth:8,env:"prod",commonParams:null},I=function(){function t(){S(this,t),this.$options={},this.commonParams={},this.inited=!1}return P(t,[{key:"init",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.inited||(this.$options=j({},N,t),this.commonParams=this.$options.commonParams||{},this.initError(),this.initApi(),this.initPerf(),this.inited=!0)}},{key:"log",value:function(t){if(!this.inited)throw new Error("必须先初始化");p(this.$options,j({},this.commonParams,t))}},{key:"initApi",value:function(){var t=new C(this.$options,this.commonParams);this.api=t,this.Api=t,this.captureApi=t.captureApi.bind(t)}},{key:"initError",value:function(){var t=new D(this.$options,this.commonParams);this.error=t,this.Error=D,this.captureError=t.captureError.bind(t)}},{key:"initPerf",value:function(){var t=new L(this.$options,this.commonParams);this.perf=t,this.Perf=L,this.capturePerf=t.capturePerf.bind(t)}}]),t}(),J=new I;return J.Ctor=I,J});
